import re
import math
from . import sv
from kokkoro.common_interface import EventInterface

# 数据来自兰德索尔图书馆
manalst = {1:0, 2:960, 3:1920, 4:2880, 5:3840, 6:4800, 7:5760, 8:6720, 9:7680, 10:8640, 11:9600, 12:11040, 13:12480, 14:13920, 15:15360, 16:17200, 17:19440, 18:22080, 19:25120, 20:28560, 21:32400, 22:36640, 23:41280, 24:46320, 25:51760, 26:57600, 27:63840, 28:70480, 29:77520, 30:84960, 31:92800, 32:101840, 33:112080, 34:123520, 35:136160, 36:150000, 37:165040, 38:184080, 39:207120, 40:234160, 41:265200, 42:300240, 43:339280, 44:382320, 45:429760, 46:481600, 47:537840, 48:598480, 49:663520, 50:732960, 51:806800, 52:885040, 53:967680, 54:1053560, 55:1142640, 56:1234920, 57:1330400, 58:1429080, 59:1530960, 60:1636040, 61:1744320, 62:1855800, 63:1970480, 64:2088360, 65:2209440, 66:2333720, 67:2461200, 68:2591880, 69:2725760, 70:2862840, 71:3003120, 72:3146600, 73:3293280, 74:3443160, 75:3596240, 76:3752520, 77:3912000, 78:4074680, 79:4240560, 80:4409640, 81:4581920, 82:4757400, 83:4936080, 84:5117960, 85:5303040, 86:5491320, 87:5682800, 88:5877480, 89:6075360, 90:6276440, 91:6480720, 92:6688200, 93:6898880, 94:7112760, 95:7329840, 96:7550120, 97:7773600, 98:8000280, 99:8230160, 100:8463240, 101:8699520, 102:8939000, 103:9181680, 104:9427560, 105:9676640, 106:9928920, 107:10184400, 108:10443080, 109:10704960, 110:10970040, 111:11238320, 112:11509800, 113:11784480, 114:12062360, 115:12343440, 116:12627720, 117:12915200, 118:13205880, 119:13499760, 120:13796840, 121:14097120, 122:14400600, 123:14707280, 124:15017160, 125:15330240, 126:15646520, 127:15966000, 128:16288680, 129:16614560, 130:16943640, 131:17275920, 132:17611400, 133:17950080, 134:18291960, 135:18637040, 136:18985320, 137:19336800, 138:19691480, 139:20049360, 140:20410440, 141:20774720, 142:21142200, 143:21512880, 144:21886760, 145:22263840, 146:22644120, 147:23027600, 148:23414280, 149:23804160, 150:24197240, 151:24593520, 152:24993000, 153:25395680, 154:25801560, 155:26210640, 156:26622920, 157:27038400, 158:27457080, 159:27878960, 160:28304040, 161:28732320, 162:29163800, 163:29598480, 164:30036360, 165:30477440, 166:30921720, 167:31369200, 168:31819880, 169:32273760}
explst = {1:0, 2:24, 3:72, 4:120, 5:168, 6:216, 7:288, 8:360, 9:432, 10:504, 11:576, 12:648, 13:720, 14:792, 15:864, 16:956, 17:1068, 18:1200, 19:1352, 20:1524, 21:1716, 22:1928, 23:2142, 24:2358, 25:2576, 26:2796, 27:3019, 28:3245, 29:3474, 30:3706, 31:3948, 32:4200, 33:4462, 34:4734, 35:5016, 36:5308, 37:5610, 38:5962, 39:6364, 40:6816, 41:7318, 42:7870, 43:8622, 44:9574, 45:10726, 46:12078, 47:13630, 48:15382, 49:17534, 50:20086, 51:23038, 52:26390, 53:30142, 54:34394, 55:39146, 56:44398, 57:50150, 58:56402, 59:63154, 60:70406, 61:78158, 62:86410, 63:95162, 64:104514, 65:114466, 66:125018, 67:136170, 68:147922, 69:160274, 70:173226, 71:186778, 72:200930, 73:215682, 74:231034, 75:246986, 76:263538, 77:280690, 78:298442, 79:316794, 80:335746, 81:355298, 82:375450, 83:396202, 84:417554, 85:439506, 86:462058, 87:485210, 88:508962, 89:533314, 90:558266, 91:583818, 92:609970, 93:636722, 94:664074, 95:692026, 96:720578, 97:749730, 98:779482, 99:809834, 100:840786, 101:872338, 102:904490, 103:937242, 104:970594, 105:1004546, 106:1039098, 107:1074250, 108:1110002, 109:1146354, 110:1183306, 111:1220858, 112:1259010, 113:1297762, 114:1337114, 115:1377066, 116:1417618, 117:1458770, 118:1500522, 119:1542874, 120:1585826, 121:1629378, 122:1673530, 123:1718282, 124:1763634, 125:1809586, 126:1856138, 127:1903290, 128:1951042, 129:1999394, 130:2048346, 131:2097898, 132:2148050, 133:2198802, 134:2250154, 135:2302106, 136:2354658, 137:2407810, 138:2461562, 139:2515914, 140:2570866, 141:2626418, 142:2682570, 143:2739322, 144:2796674, 145:2854626, 146:2913178, 147:2972330, 148:3032082, 149:3092434, 150:3153386, 151:3214938, 152:3277090, 153:3339842, 154:3403194, 155:3467146, 156:3531698, 157:3596850, 158:3662602, 159:3728954, 160:3795906, 161:3863458, 162:3931610, 163:4000362, 164:4069714, 165:4139666, 166:4210218, 167:4281370, 168:4353122, 169:4425474, 170:4498426}

@sv.on_prefix(('角色计算'))
async def manaburner(bot, ev: EventInterface):
    prm = re.findall("\d+", ev.get_param().remain)
    if len(prm) == 0 or len(prm) >= 4:
        return "使用方法：\n角色计算 [[角色数量] 当前等级 ]目标等级"
    elif len(prm) == 1:
        n = 1
        l = 1
        r = int(prm[0])
    elif len(prm) == 2:
        n = 1
        l = int(prm[0])
        r = int(prm[1])
    elif len(prm) == 3:
        n = int(prm[0])
        l = int(prm[1])
        r = int(prm[2])
    try:
        mana = (manalst[r] - manalst[l]) * n
        exp = (explst[r] - explst[l]) * n
        bottle = math.ceil(exp/7500)
        buyexp = math.ceil(exp/0.375)
        msg = f"{n}名角色从{l}级升到{r}级需要：\n{mana:,} mana\n{exp:,} 经验\n约{bottle:,}瓶超级经验药水（价值 {buyexp:,} mana）"
    except:
        msg = "0x0 好像超出了等级上限呢"
    await bot.kkr_send(ev, msg, at_sender=True)
